<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viking Game - Visual Novel</title>
    <style>
        * {
            --text-box-background: #19152C;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            background: linear-gradient(to bottom, #232830, #222933);
            position: relative;
            padding: 20px;
        }

        .screen {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 1;
            transition: opacity 1s ease-in-out;
            display: none;
        }

        .screen.active {
            display: block;
        }

        #black-overlay {
            position: fixed;
            inset: 0;
            background-color: black;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
            z-index: 1000;
        }

        #black-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        #start-screen {
            background-image: url('assets/start_screen.jpg');
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #start-menu {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            color: white;
            max-width: 40vw;
        }

        #cinematic-ui {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        /* Remove the previous pseudo-element approach */
        .opacity-transition::before {
            content: none;
        }

        .screen:not(.active) {
            display: none !important;
        }

        #cinematic-frame {
            width: 95%;
            max-height: 95vh;
            aspect-ratio: 620/360;
            position: relative;
            margin: 0 auto;

            /* Use padding instead of border to create space for the border image */
            padding: 9px;
            box-sizing: border-box;
            background-origin: padding-box;
            background-clip: padding-box;
            
            /* Apply border image */
            border: none;
            background-image: 
                url('assets/Cinematic_UI_Frame.png'),
                url('assets/prologue_screen.png');
            background-size: 
                100% 100%,  /* Border image size */
                calc(100% - 18px) calc(100% - 18px);  /* Content image size */
            background-position: 
                center center,  /* Border image position */
                center center;  /* Content image position */
            background-repeat: no-repeat, no-repeat;
            
            /* Remove other potentially conflicting properties */
            overflow: visible;
        }

        /* Remove the pseudo-element since we're using multiple backgrounds */
        #cinematic-frame::before {
            content: none;
        }

        #cinematic-text-box {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            min-height: 150px;
            width: calc(100% - 40px);
            padding: 20px;
            font-size: clamp(1rem, 1.5vw, 1.2rem);
            line-height: 1.5;
            color: white;
            opacity: 0;
            transition: opacity 1s ease-in-out;

            border: 9px solid transparent;
            border-image-source: url('assets/Text_Box.png');
            border-image-slice: 9;
            border-image-width: 1;
            border-image-outset: 0.4;
            border-image-repeat: stretch;
            background-color: rgba(25, 21, 44, 0);
            transition: background-color 1s ease-in-out, opacity 1s ease-in-out;
        }

        #cinematic-text-box.visible {
            opacity: 1;
            background-color: rgba(25, 21, 44, 0.8);
        }

        #cinematic-ui.opacity-transition #cinematic-text-box {
            opacity: 1;
            background-color: rgba(25, 21, 44, 0.8);
        }

        #cinematic-text-content {
            margin-bottom: 15px;
        }

        #next-button {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            float: right;
        }

        #next-button:hover {
            background-color: #357abd;
        }

        .btn {
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin: 1rem;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn img {
            max-width: 200px;
            height: auto;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
        }

        .click-indicator {
            text-align: right;
            margin-top: 10px;
            color: #e3e3e3;
            animation: pulse 1.5s infinite;
            font-size: 1.2rem;
        }
        
        @keyframes pulse {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div id="black-overlay"></div>
    <div id="start-screen" class="screen active">
        <div id="start-menu">
            <h1>Viking Game</h1>
            <button class="btn" id="start-game">
                <img src="assets/start_button.png" alt="Start Game">
            </button>
        </div>
    </div>

    <div id="cinematic-ui" class="screen">
        <div id="cinematic-frame">
            <div id="cinematic-text-box">
                <div id="cinematic-text-content"></div>
            </div>
            <div id="cinematic-button-box">

            </div>
        </div>
    </div>

    <script>
        // Screen management
        const screens = {
            start: document.getElementById('start-screen'),
            prologue: document.getElementById('cinematic-ui')
        };

        function transitionToScreen(fromScreen, toScreen) {
            const blackOverlay = document.getElementById('black-overlay');

            // First fade to black
            blackOverlay.classList.add('active');

            // Wait for fade to black
            setTimeout(() => {
                // Hide the current screen
                fromScreen.classList.remove('active');

                // Show the new screen
                toScreen.classList.add('active');

                // Fade out the black overlay
                blackOverlay.classList.remove('active');

                // Wait for the black overlay to finish fading out
                blackOverlay.addEventListener('transitionend', function onTransitionEnd() {
                    blackOverlay.removeEventListener('transitionend', onTransitionEnd);
                    
                    // Start the opacity effect transition
                    const cinematicUI = document.getElementById('cinematic-ui');
                    if (cinematicUI.classList.contains('active')) {
                        cinematicUI.classList.add('opacity-transition');
                        
                        // After UI is active, display the first story text
                        setTimeout(() => {
                            displayStoryText(0);
                        }, 500);
                    }
                });
            }, 1000);
        }

        // Start game button handler
        document.getElementById('start-game').addEventListener('click', () => {
            transitionToScreen(screens.start, screens.prologue);
        });

        // Text box management
        // Replace linear storyText array with a structured story object
        const storyNodes = {
            0: {
                text: "..You emerge from vague, unsatisfying fever dream... The crossroads, the ravens... a choice... resonance... faces... delirium...",
                next: 1
            },
            1: {
                text: "You awaken, uncharacteristically thankful for the ceaseless salt-spit breeze. Your fever recedes... You've been sailing for 8 days now, aboard one of the three Snekkja comprising Hersir Olaf's warband. Erik stirs before waking up with a familiar groan of dissatisfaction, he hasn't taken well to the sea... an embarrassing detail noted by your proud crewmates, but he is still your friend after all.",
                next: 2
            },
            2: {
                text: "Following the barked commands and surefooted actions of your more seasoned crewmates, you and Erik prepare to land... *Crash* â€¦ The ship bucks suddenly, tilting and causing men left and right to stumble and fall...",
                choices: [
                    { text: "Grab onto the ship's rail", nextNode: 3 },
                    { text: "Help Erik keep his balance", nextNode: 4 },
                    { text: "Brace yourself against the deck", nextNode: 5 }
                ]
            },
            3: {
                text: "You lunge for the rail, fingers wrapping around the salt-crusted wood just as the ship lurches violently. You manage to stay upright while others tumble around you. From your stable position, you see what happened - the ship has struck a submerged rock, and water is already beginning to seep through the hull.",
                next: 6
            },
            4: {
                text: "You reach for Erik, grabbing his arm as he begins to pitch forward. He clutches at you gratefully as the ship stabilizes. 'Thanks, friend,' he mutters, his face pale. Your act of loyalty hasn't gone unnoticed - you catch Hersir Olaf nodding approvingly from the stern of the ship.",
                next: 6
            },
            5: {
                text: "You widen your stance and lower your center of gravity, bracing against the deck planks. The sudden shift throws even veteran warriors off balance, but you remain steady. Your quick instincts mark you as one with a natural feel for the sea, earning respectful glances from the older crew members.",
                next: 6
            },
            6: {
                text: "The ship settles, but the damage is done. 'LAND! NOW!' bellows Hersir Olaf, pointing to the nearby shore. 'Everyone row! We're taking on water!' The crew leaps into action, and you join them at the oars, muscles straining as you race against the slowly rising water in the hull...",
                choices: [
                    { text: "Row with all your might", nextNode: 7 },
                    { text: "Help bail out water", nextNode: 8 }
                ]
            },
            7: {
                text: "You throw your back into the rowing, joining the rhythmic grunt and pull of the oarsmen. Your shoulders burn with the effort, but the shore grows closer with each stroke. The ship's master nods at your effort - such strength will be remembered.",
                next: 9
            },
            8: {
                text: "While others row, you grab a bucket and start bailing. The cold seawater soaks your boots, but your quick action helps keep the ship from sinking too quickly. 'Good thinking,' grunts a grizzled warrior next to you, as you both work to keep the vessel afloat.",
                next: 9
            },
            9: {
                text: "With a grinding crunch, the ship beaches itself on the rocky shore. 'Everyone out!' commands Olaf. 'Salvage what you can!' You've reached the strange new land, though not quite as planned. Your journey has only just begun...",
                end: true
            }
        };

        let currentNodeId = 0;
        const textBox = document.getElementById('cinematic-text-box');
        const textContent = document.getElementById('cinematic-text-content');
        const choiceBox = document.getElementById('cinematic-button-box');

        // Functions for the story progression
        
        // Typewriter effect for text display
        let typewriterActive = false;
        let typewriterCancel = false;

        function typewriterEffect(element, text, speed = 30) {
            // If there's already a typewriter effect running, cancel it
            if (typewriterActive) {
                typewriterCancel = true;
                // Give a small delay to ensure the previous typewriter is properly stopped
                return new Promise(resolve => {
                    setTimeout(() => {
                        typewriterCancel = false;
                        return typewriterEffect(element, text, speed).then(resolve);
                    }, 50);
                });
            }

            element.innerHTML = '';
            let i = 0;
            typewriterActive = true;
            typewriterCancel = false;
            
            return new Promise(resolve => {
                function typeNextChar() {
                    if (typewriterCancel) {
                        typewriterActive = false;
                        resolve();
                        return;
                    }

                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(typeNextChar, speed);
                    } else {
                        typewriterActive = false;
                        resolve();
                        // Add click indicator after text is fully typed
                        if (!document.querySelector('.click-indicator')) {
                            const indicator = document.createElement('div');
                            indicator.className = 'click-indicator';
                            indicator.textContent = 'Click to continue...';
                            textBox.appendChild(indicator);
                        }
                    }
                }
                typeNextChar();
            });
        }

        // Display story text for the current node
        async function displayStoryText(nodeId) {
            // Cancel any active typewriter effect
            typewriterCancel = true;
            
            // Small delay to ensure typewriter is cancelled
            await new Promise(resolve => setTimeout(resolve, 50));
            
            currentNodeId = nodeId;
            const currentNode = storyNodes[nodeId];
            
            // Clear any existing choices
            choiceBox.innerHTML = '';
            
            // Remove any existing click indicators
            const existingIndicator = document.querySelector('.click-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Make text box visible
            textBox.classList.add('visible');
            
            // Clear text content before starting new typewriter effect
            textContent.innerHTML = '';
            
            // Display the text with typewriter effect
            await typewriterEffect(textContent, currentNode.text);
            
            // Check if this node has choices
            if (currentNode.choices) {
                displayChoices(currentNode.choices);
            }
        }
        
        // Display choices for the current node
        function displayChoices(choices) {
            choiceBox.innerHTML = '';
            
            // Create a styled container for the choices
            const choiceContainer = document.createElement('div');
            choiceContainer.style.position = 'absolute';
            choiceContainer.style.bottom = '20px';
            choiceContainer.style.left = '0';
            choiceContainer.style.right = '0';
            choiceContainer.style.display = 'flex';
            choiceContainer.style.justifyContent = 'center';
            choiceContainer.style.flexWrap = 'wrap';
            choiceContainer.style.gap = '10px';
            
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice.text;
                button.style.padding = '10px 20px';
                button.style.margin = '5px';
                button.style.backgroundColor = '#4a90e2';
                button.style.color = 'white';
                button.style.border = 'none';
                button.style.borderRadius = '5px';
                button.style.cursor = 'pointer';
                button.style.fontSize = '16px';
                button.style.transition = 'transform 0.2s';
                
                button.addEventListener('mouseover', () => {
                    button.style.transform = 'scale(1.05)';
                });
                
                button.addEventListener('mouseout', () => {
                    button.style.transform = 'scale(1.0)';
                });
                
                button.addEventListener('click', () => {
                    handleChoiceSelection(choice.nextNode);
                });
                
                choiceContainer.appendChild(button);
            });
            
            choiceBox.appendChild(choiceContainer);
        }
        
        // Handle the player's choice selection
        function handleChoiceSelection(nextNodeId) {
            displayStoryText(nextNodeId);
        }
        
        // Handle click to advance text when there are no choices
        document.getElementById('cinematic-frame').addEventListener('click', () => {
            const currentNode = storyNodes[currentNodeId];
            
            // Only allow advancing if we're not showing choices
            if (!currentNode.choices) {
                if (currentNode.next) {
                    displayStoryText(currentNode.next);
                } else if (currentNode.end) {
                    console.log("End of story reached"); 
                    // Here you could add code to end the game or move to the next chapter
                }
            }
        });
    </script>
</body>
</html>
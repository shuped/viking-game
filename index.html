<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viking Game - Visual Novel</title>
    <style>
        * {
            --text-box-background: #19152C;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            background: linear-gradient(to bottom, #232830, #222933);
            position: relative;
            padding: 20px;
        }

        .screen {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 1;
            transition: opacity 1s ease-in-out;
            display: none;
        }

        .screen.active {
            display: block;
        }

        #black-overlay {
            position: fixed;
            inset: 0;
            background-color: black;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
            z-index: 1000;
        }

        #black-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        #start-screen {
            background-image: url('assets/start_screen.jpg');
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #start-menu {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            color: white;
            max-width: 40vw;
        }

        #cinematic-ui {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        /* Remove the previous pseudo-element approach */
        .opacity-transition::before {
            content: none;
        }

        .screen:not(.active) {
            display: none !important;
        }

        #cinematic-frame {
            width: 95%;
            max-height: 95vh;
            aspect-ratio: 620/360;
            position: relative;
            margin: 0 auto;

            /* Use padding instead of border to create space for the border image */
            padding: 9px;
            box-sizing: border-box;
            background-origin: padding-box;
            background-clip: padding-box;
            
            /* Apply border image */
            border: none;
            background-image: 
                url('assets/Cinematic_UI_Frame.png'),
                url('assets/prologue_screen.png');
            background-size: 
                100% 100%,  /* Border image size */
                calc(100% - 18px) calc(100% - 18px);  /* Content image size */
            background-position: 
                center center,  /* Border image position */
                center center;  /* Content image position */
            background-repeat: no-repeat, no-repeat;
            
            /* Remove other potentially conflicting properties */
            overflow: visible;
        }

        /* Remove the pseudo-element since we're using multiple backgrounds */
        #cinematic-frame::before {
            content: none;
        }

        #cinematic-text-box {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            min-height: 150px;
            width: calc(100% - 40px);
            padding: 20px;
            font-size: clamp(1rem, 1.5vw, 1.2rem);
            line-height: 1.5;
            color: white;
            opacity: 0;
            transition: opacity 1s ease-in-out;

            border: 9px solid transparent;
            border-image-source: url('assets/Text_Box.png');
            border-image-slice: 9;
            border-image-width: 1;
            border-image-outset: 0.4;
            border-image-repeat: stretch;
            background-color: rgba(25, 21, 44, 0);
            transition: background-color 1s ease-in-out, opacity 1s ease-in-out;
        }

        #cinematic-text-box.visible {
            opacity: 1;
            background-color: rgba(25, 21, 44, 0.8);
        }

        #cinematic-ui.opacity-transition #cinematic-text-box {
            opacity: 1;
            background-color: rgba(25, 21, 44, 0.8);
        }

        #cinematic-text-content {
            margin-bottom: 15px;
        }

        #next-button {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            float: right;
        }

        #next-button:hover {
            background-color: #357abd;
        }

        .btn {
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin: 1rem;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn img {
            max-width: 200px;
            height: auto;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
        }

        .click-indicator {
            text-align: right;
            margin-top: 10px;
            color: #e3e3e3;
            animation: pulse 1.5s infinite;
            font-size: 1.2rem;
        }
        
        @keyframes pulse {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div id="black-overlay"></div>
    <div id="start-screen" class="screen active">
        <div id="start-menu">
            <h1>Viking Game</h1>
            <button class="btn" id="start-game">
                <img src="assets/start_button.png" alt="Start Game">
            </button>
        </div>
    </div>

    <div id="cinematic-ui" class="screen">
        <div id="cinematic-frame">
            <div id="cinematic-text-box">
                <div id="cinematic-text-content"></div>
            </div>
            <div id="cinematic-button-box">

            </div>
        </div>
    </div>

    <script>
        // Screen management
        const screens = {
            start: document.getElementById('start-screen'),
            prologue: document.getElementById('cinematic-ui')
        };

        function transitionToScreen(fromScreen, toScreen) {
            const blackOverlay = document.getElementById('black-overlay');

            // First fade to black
            blackOverlay.classList.add('active');

            // Wait for fade to black
            setTimeout(() => {
                // Hide the current screen
                fromScreen.classList.remove('active');

                // Show the new screen
                toScreen.classList.add('active');

                // Fade out the black overlay
                blackOverlay.classList.remove('active');

                // Wait for the black overlay to finish fading out
                blackOverlay.addEventListener('transitionend', function onTransitionEnd() {
                    blackOverlay.removeEventListener('transitionend', onTransitionEnd);
                    
                    // Start the opacity effect transition
                    const cinematicUI = document.getElementById('cinematic-ui');
                    if (cinematicUI.classList.contains('active')) {
                        cinematicUI.classList.add('opacity-transition');
                        
                        // After UI is active, display the first story text
                        setTimeout(() => {
                            displayStoryText(0);
                        }, 500);
                    }
                });
            }, 1000);
        }

        // Start game button handler
        document.getElementById('start-game').addEventListener('click', () => {
            transitionToScreen(screens.start, screens.prologue);
        });

        // Text box management
        // Replace linear storyText array with a structured story object
        const storyNodes = {
            0: {
                text: "..You emerge from vague, unsatisfying fever dream... The crossroads, the ravens... a choice... resonance... faces... delirium...",
                next: 1
            },
            1: {
                text: "You awaken, uncharacteristically thankful for the ceaseless salt-spit breeze. Your fever recedes... You've been sailing for 8 days now, aboard one of the three Snekkja comprising Hersir Olaf's warband. Erik stirs before waking up with a familiar groan of dissatisfaction, he hasn't taken well to the sea... an embarrassing detail noted by your proud crewmates, but he is still your friend after all.",
                next: 2
            },
            2: {
                text: "Following the barked commands and surefooted actions of your more seasoned crewmates, you and Erik prepare to land... *Crash* … The ship bucks suddenly, tilting and causing men left and right to stumble and fall...",
                choices: [
                    { text: "Try to keep your balance", nextNode: 3 },
                    { text: "Brace against the tide", nextNode: 4 }
                ]
            },
            3: {
                text: "You struggle to maintain your footing, but the ship's violent motion throws you off balance. You tumble to the deck, banging your knee painfully against the wood. Several of your comrades snicker as you pick yourself up, your pride more wounded than your body.",
                next: 5
            },
            4: {
                text: "As others lose their balance around you, you widen your stance and lower your center of gravity. You remain standing even as the ship bucks and tilts. Several of your crewmates nod approvingly at your display of seamanship. Your reputation among the warband increases slightly.",
                next: 5
            },
            5: {
                text: "Steps away, the steering ore sits vacant as the shore approaches at a menacing pace...",
                choices: [
                    { text: "Fall in line, obeying the scattered commands of more experienced seamen", nextNode: 6 },
                    { text: "Seize the steering ore, taking matters into your own hands", nextNode: 7 }
                ]
            },
            6: {
                text: "You follow the shouted orders of the more experienced warriors around you, helping to secure ropes and prepare for landing. The situation gradually comes under control as the ship lurches toward the shore. Your actions, while helpful, go largely unnoticed in the chaos.",
                next: 10
            },
            7: {
                text: "You leap toward the unmanned steering ore, gripping it firmly in your hands. The weight of it surprises you as you struggle to control the direction of the ship...",
                choices: [
                    { text: "Push through the struggle", nextNode: 8 },
                    { text: "Give up and let someone else handle it", nextNode: 9 }
                ]
            },
            8: {
                text: "Summoning your resolve, you wrestle with the heavy steering ore. Your muscles strain as you fight against the current, but you manage to guide the groaning vessel safely toward the shore. As the calamity dissipates, your comrades grumble quiet words of approval. Your reputation has increased among the warband.",
                next: 10
            },
            9: {
                text: "You struggle with the ore in an embarrassing display of weakness. Your arms shake with the effort before you're unceremoniously shoved aside by a pair of stronger hands. 'Out of the way, weakling!' growls a bearded warrior as he takes control. Your cheeks burn with shame as several crewmates smirk at your failure.",
                next: 10
            },
            10: {
                text: "Just as the third and final Snekkja anchors to the shore, a rush of excitement breaks through the disorganized mass of your warband... 'SAXONS!' The cry goes up, and warriors scramble for their weapons. Through the trees, you glimpse figures moving—local defenders rushing to repel your landing.",
                next: 11
            },
            11: {
                text: "[Battle with Saxons - Your first real combat experience]",
                next: 12
            },
            12: {
                text: "The clash of steel fades as the last Saxon falls. Breathing heavily, you contemplate your actions in the battle...",
                choices: [
                    { text: "Rejoice in your victory", nextNode: 13 },
                    { text: "Question the senseless violence", nextNode: 14 }
                ]
            },
            13: {
                text: "You raise your weapon and let out a victorious cry that is echoed by your comrades. The thrill of battle still courses through your veins, and you feel a deep satisfaction in your triumph over the enemy. The Black Raven's shadow seems to pass over you, approving of your warrior spirit.",
                next: 15
            },
            14: {
                text: "As your comrades celebrate around you, you stare down at the bodies of the fallen with unease. Was this slaughter necessary? These people were simply defending their homes. A strange feeling washes over you, as if a White Raven watches your moment of doubt with interest.",
                next: 15
            },
            15: {
                text: "With the immediate threat dispatched, you must decide how to use the brief moment of respite...",
                choices: [
                    { text: "Search for loot among the dead", nextNode: 16 },
                    { text: "Take the opportunity to rest", nextNode: 17 }
                ]
            },
            16: {
                text: "You move among the fallen Saxons, searching their bodies for anything of value. You find a few small trinkets and coins, but the effort leaves you more exhausted than before. Your fatigue increases, but your small haul might prove useful later.",
                next: 18
            },
            17: {
                text: "You find a quiet spot to sit and catch your breath. The brief rest revitalizes you somewhat, clearing your mind and reducing your fatigue. Erik joins you, grateful for the moment of peace before the next challenge.",
                next: 18
            },
            18: {
                text: "The Saxon insurgence was desperate and disorganized... victory here is only the beginning. Hersir Olaf assigns a small party of mysterious warriors to scout the area while the rest of your party makes camp. It won't be long before you see more serious combat...",
                next: 19
            },
            19: {
                text: "[Camp - Time to rest, train, and prepare]",
                next: 20
            },
            20: {
                text: "The time has come to move on. Your warband breaks camp at dawn, moving inland with purpose. By midday, a church on a hill comes into view, with a modest if not idyllic town surrounding it. The Hersir maintains a tight grip on your eager companions, but it won't last forever...",
                next: 21
            },
            21: {
                text: "The Saxon resistance forms even as your party closes the gap between them and the village. Before long, your party is standing face to face with a Saxon contingent of roughly equal size, their weapons drawn and faces grim with determination.",
                next: 22
            },
            22: {
                text: "[Battle with Saxon defenders]",
                next: 23
            },
            23: {
                text: "The Saxon resistance shatters, their warriors no match for your own... what had been a disciplined cohort of Viking warriors devolves into a wave of blood-red savagery... a free-for-all...",
                next: 24
            },
            24: {
                text: "You find yourself at the foot of the town, violent activity surrounding you. The screams of villagers mix with the triumphant shouts of your fellow warriors. What will you do next?",
                choices: [
                    { text: "Go straight for the church", nextNode: 25 },
                    { text: "Go into the nearest house", nextNode: 26 },
                    { text: "Walk around aimlessly", nextNode: 27 },
                    { text: "Listen to Erik", nextNode: 28 }
                ]
            },
            25: {
                text: "You make your way toward the church on the hill, drawn to the prominent structure overlooking the town. As you approach, you notice several of your fellow warriors heading in the same direction, likely expecting valuable treasures inside...",
                next: 29
            },
            26: {
                text: "You push open the door to the nearest house. Inside, you find simple furnishings and signs of a hasty departure. You search through some personal belongings but find little of value. Time passes, and you hear the continued sounds of chaos outside.",
                next: 30
            },
            27: {
                text: "You wander through the streets of the small town, observing the destruction around you. Warriors pillage homes while terrified villagers flee or hide. You spend some time taking in the scene, but accomplish little. The day wears on.",
                next: 30
            },
            28: {
                text: "Erik gestures for you to follow him. 'I heard the Hersir mention that the church would have the most valuable items,' he says with a gleam in his eye. 'We should head there before the others take everything!'",
                next: 25
            },
            29: {
                text: "[Church scene - continues to Chapter 1 Church]",
                end: true
            },
            30: {
                text: "As you finish exploring, you realize that most of your warband seems to be converging on the church. Perhaps that's where you should go next...",
                choices: [
                    { text: "Go to the church", nextNode: 25 },
                    { text: "Check another house", nextNode: 26 },
                    { text: "Continue wandering", nextNode: 27 }
                ]
            }
        };

        let currentNodeId = 0;
        const textBox = document.getElementById('cinematic-text-box');
        const textContent = document.getElementById('cinematic-text-content');
        const choiceBox = document.getElementById('cinematic-button-box');

        // Functions for the story progression
        
        // Typewriter effect for text display
        let typewriterActive = false;
        let typewriterCancel = false;

        function typewriterEffect(element, text, speed = 30) {
            // If there's already a typewriter effect running, cancel it
            if (typewriterActive) {
                typewriterCancel = true;
                // Give a small delay to ensure the previous typewriter is properly stopped
                return new Promise(resolve => {
                    setTimeout(() => {
                        typewriterCancel = false;
                        return typewriterEffect(element, text, speed).then(resolve);
                    }, 50);
                });
            }

            element.innerHTML = '';
            let i = 0;
            typewriterActive = true;
            typewriterCancel = false;
            
            return new Promise(resolve => {
                function typeNextChar() {
                    if (typewriterCancel) {
                        typewriterActive = false;
                        resolve();
                        return;
                    }

                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(typeNextChar, speed);
                    } else {
                        typewriterActive = false;
                        resolve();
                        // Add click indicator after text is fully typed
                        if (!document.querySelector('.click-indicator')) {
                            const indicator = document.createElement('div');
                            indicator.className = 'click-indicator';
                            indicator.textContent = 'Click to continue...';
                            textBox.appendChild(indicator);
                        }
                    }
                }
                typeNextChar();
            });
        }

        // Display story text for the current node
        async function displayStoryText(nodeId) {
            // Cancel any active typewriter effect
            typewriterCancel = true;
            
            // Small delay to ensure typewriter is cancelled
            await new Promise(resolve => setTimeout(resolve, 50));
            
            currentNodeId = nodeId;
            const currentNode = storyNodes[nodeId];
            
            // Clear any existing choices
            choiceBox.innerHTML = '';
            
            // Remove any existing click indicators
            const existingIndicator = document.querySelector('.click-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Make text box visible
            textBox.classList.add('visible');
            
            // Clear text content before starting new typewriter effect
            textContent.innerHTML = '';
            
            // Display the text with typewriter effect
            await typewriterEffect(textContent, currentNode.text);
            
            // Check if this node has choices
            if (currentNode.choices) {
                displayChoices(currentNode.choices);
            }
        }
        
        // Display choices for the current node
        function displayChoices(choices) {
            choiceBox.innerHTML = '';
            
            // Create a styled container for the choices that resembles the text box
            const choiceContainer = document.createElement('div');
            choiceContainer.style.position = 'absolute';
            choiceContainer.style.bottom = '20px';
            choiceContainer.style.left = '20px';
            choiceContainer.style.right = '20px';
            choiceContainer.style.padding = '20px';
            choiceContainer.style.color = 'white';
            choiceContainer.style.fontSize = 'clamp(1rem, 1.5vw, 1.2rem)';
            
            // Apply the same border image as the text box
            choiceContainer.style.border = '9px solid transparent';
            choiceContainer.style.borderImageSource = 'url(\'assets/Text_Box.png\')';
            choiceContainer.style.borderImageSlice = '9';
            choiceContainer.style.borderImageWidth = '1';
            choiceContainer.style.borderImageOutset = '0.4';
            choiceContainer.style.borderImageRepeat = 'stretch';
            choiceContainer.style.backgroundColor = 'rgba(25, 21, 44, 0.8)';
            
            // Create a header for choices
            const choiceHeader = document.createElement('div');
            choiceHeader.textContent = 'What will you do?';
            choiceHeader.style.marginBottom = '15px';
            choiceHeader.style.fontStyle = 'italic';
            choiceHeader.style.textAlign = 'center';
            choiceContainer.appendChild(choiceHeader);
            
            // Create a list for choices
            const choiceList = document.createElement('ul');
            choiceList.style.listStyleType = 'none';
            choiceList.style.padding = '0';
            choiceList.style.margin = '0';
            choiceList.style.display = 'flex';
            choiceList.style.flexDirection = 'column';
            choiceList.style.gap = '10px';
            
            choices.forEach((choice, index) => {
                const choiceItem = document.createElement('li');
                choiceItem.textContent = `${index + 1}. ${choice.text}`;
                choiceItem.style.cursor = 'pointer';
                choiceItem.style.transition = 'transform 0.2s, color 0.2s';
                choiceItem.style.padding = '5px 10px';
                
                // Highlight effect on hover
                choiceItem.addEventListener('mouseover', () => {
                    choiceItem.style.transform = 'translateX(10px)';
                    choiceItem.style.color = '#4a90e2';
                });
                
                choiceItem.addEventListener('mouseout', () => {
                    choiceItem.style.transform = 'translateX(0)';
                    choiceItem.style.color = 'white';
                });
                
                choiceItem.addEventListener('click', () => {
                    handleChoiceSelection(choice.nextNode);
                });
                
                choiceList.appendChild(choiceItem);
            });
            
            choiceContainer.appendChild(choiceList);
            choiceBox.appendChild(choiceContainer);
        }
        
        // Handle the player's choice selection
        function handleChoiceSelection(nextNodeId) {
            displayStoryText(nextNodeId);
        }
        
        // Handle click to advance text when there are no choices
        document.getElementById('cinematic-frame').addEventListener('click', () => {
            const currentNode = storyNodes[currentNodeId];
            
            // Only allow advancing if we're not showing choices
            if (!currentNode.choices) {
                if (currentNode.next) {
                    displayStoryText(currentNode.next);
                } else if (currentNode.end) {
                    console.log("End of story reached"); 
                    // Here you could add code to end the game or move to the next chapter
                }
            }
        });
    </script>
</body>
</html>